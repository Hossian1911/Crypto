# 常驻服务与定时任务说明

## 机制概览
- **[常驻循环]** `main.py` 启动后不退出，内部每 8 小时执行一次完整流程（抓取 → 处理 → 出表入库）。
- **[防重入]** 单实例锁 `app.lock`，避免重复运行。
- **[错误不中断]** 每次执行出错只记录日志，不影响下次周期。
- **[抖动]** 每轮结束后休眠 `8h + 0~60s`，避免固定时间点拥堵。
- **[无管理员权限]** 全流程不需要管理员：用户级看门狗 + 启动项自启动。

## 目录与关键文件
- **[`main.py`]** 常驻入口，内建 8 小时调度与日志、单实例。
- **[`result/_logs/`]** 日志目录。
  - **[`result/_logs/app.log`]** 应用日志（服务级别）。
  - 子任务 `stdout/stderr` 会各自落到带时间戳的日志文件中。
- **[`app.lock`]** 单实例锁文件。

## 如何启动
- **[直接运行]** 命令行执行：
```powershell
python main.py
```

## 如何退出
- **[临时退出]** 直接关闭运行窗口（看门狗或 main 的窗口）。
- **[完全退出并允许再次启动]** 若提示已有实例在运行，可删除根目录的 `app.lock` 后再启动。

## 日志查看
- 应用日志：`result/_logs/app.log`
- 子任务日志：`result/_logs/` 目录下按时间戳区分的 `*.stdout.log` / `*.stderr.log`

## 常见问题
- **[为什么提示“已有实例在运行”]**
  - 说明 `app.lock` 存在，代表已有进程在跑。若确定没有，请删除 `app.lock` 后再启动。
- **[执行超过 8 小时会怎样]**
  - 下一次调度会等当前执行完毕后再开始，不会重叠。
- **[看门狗黑窗一直在]**
  - 这是正常现象，看门狗窗口用于托管与重启。如果打包为 EXE 可进一步隐藏主程序窗口（`-w`）。
